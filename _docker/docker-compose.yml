version: '3.4'
services:
  traefik:
    build: ./images/traefik/
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=us-east-1
      - AWS_HOSTED_ZONE_ID=${AWS_HOSTED_ZONE_ID}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /srv/acme:/etc/traefik/acme
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - web
    restart: unless-stopped
  nginx:
    container_name: nginx
    build:
      context: ./images/nginx
    labels:
      traefik.enable: "true"
      traefik.backend: "nginx"
      traefik.frontend.rule: "Host:pasztor.at,www.pasztor.at"
      traefik.port: "80"
      traefik.protocol: "http"
      traefik.frontend.headers.SSLTemporaryRedirect: "false"
      traefik.frontend.headers.SSLRedirect: "true"
      traefik.frontend.headers.STSSeconds: "315360000"
      traefik.frontend.headers.STSIncludeSubdomains: "true"
      traefik.frontend.headers.STSPreload: "true"
      traefik.frontend.headers.forceSTSHeader: "false"
    networks:
      - web
    volumes:
      - type: bind
        source: /srv/www
        target: /var/www
      - type: bind
        source: /srv/ssl
        target: /etc/nginx/ssl
    restart: unless-stopped
  php:
    container_name: php
    image: opsbears/php-fpm:7.2
    networks:
      - web
    volumes:
      - type: bind
        source: /srv/www
        target: /var/www
    restart: unless-stopped
  etcd:
    container_name: etcd
    image: opsbears/etcd
    networks:
      - web
    volumes:
      - type: bind
        source: /srv/etcd
        target: /srv/etcd
    ports:
      - "12380:2380"
    environment:
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_DISCOVERY_SRV: ${ETCD_DOMAIN}
      ETCD_INITIAL_CLUSTER_ADVERTISE_PEER_URLS: http://${ETCD_HOSTNAME}:12380
      ETCD_ADVERTISE_CLIENT_URLS: http://${ETCD_HOSTNAME}:12380
      ETCD_LISTEN_CLIENT_URLS: http://${ETCD_HOSTNAME}:12380
      ETCD_LISTEN_PEER_URLS: http://${ETCD_HOSTNAME}:12380
    restart: unless-stopped
networks:
  web:
    driver: bridge
    attachable: true
